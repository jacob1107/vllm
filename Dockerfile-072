# 使用包含CUDA 12.1基础环境（需先确认该tag存在）
FROM nvidia/cuda:12.1.1-base-ubuntu20.04

# 安装系统依赖时补充CUDA开发工具
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.10 \
    python3-pip \
    build-essential \
    curl \
    git \
    # 安装CUDA开发工具链
    cuda-toolkit-12-1 \
    cuda-libraries-dev-12-1 \
    && ln -sf /usr/bin/python3.10 /usr/bin/python3 \
    && rm -rf /var/lib/apt/lists/*

# 显式安装与CUDA 12.1匹配的PyTorch版本
RUN pip3 install --no-cache-dir \
    torch==2.1.2+cu121 \
    torchvision==0.16.2+cu121 \
    torchaudio==2.1.2+cu121 \
    --index-url https://download.pytorch.org/whl/cu121

# 构建vLLM前设置CUDA路径
ENV LD_LIBRARY_PATH=/usr/local/cuda-12.1/lib64:$LD_LIBRARY_PATH
RUN git clone https://github.com/vllm-project/vllm.git && \
    cd vllm && \
    git checkout v0.7.2 && \
    # 添加--no-build-isolation避免环境隔离问题
    pip3 install -e . --no-build-isolation

# 安装 vLLM 及其核心依赖
RUN pip3 install --no-cache-dir \
   # vllm==0.7.2 \
    huggingface_hub \
    "transformers>=4.37.0" \
    "numpy>=1.22.0" \
    "ninja>=1.11.1"

# 暴露API端口
EXPOSE 8000

# 启动服务
CMD ["python3", "-m", "vllm.api_server", "--host", "0.0.0.0"]
